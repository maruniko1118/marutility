<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mtools</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* --- テーマ変数定義 --- */
        :root {
            /* ライトテーマ */
            --bg-body: #ffffff;
            --bg-sidebar: #f0f4f9;
            --bg-input: #ffffff;
            --text-main: #1f1f1f;
            --text-sub: #444746;
            --border-color: #e0e0e0;
            --accent-red: #b3261e;
            --accent-yellow: #f1c40f;
            --hover-bg: #e1e5ea;
            --sidebar-width: 280px;
            --shadow-color: rgba(0,0,0,0.1);
        }

        /* ダークテーマ */
        [data-theme="dark"] {
            --bg-body: #131314;
            --bg-sidebar: #1e1f20;
            --bg-input: #2a2b2d;
            --text-main: #e3e3e3;
            --text-sub: #c4c7c5;
            --border-color: #444746;
            --accent-red: #f2b8b5;
            --accent-yellow: #f1c40f;
            --hover-bg: #333537;
            --shadow-color: rgba(0,0,0,0.5);
        }

        body {
            font-family: "Google Sans", "Helvetica Neue", Arial, sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg-body);
            color: var(--text-main);
            display: flex;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        /* --- ヘッダーエリア (左上: メニュー/ホーム) --- */
        .header-left {
            position: fixed; top: 10px; left: 10px; z-index: 1001;
            display: flex; gap: 8px; align-items: center;
        }
        
        /* --- ヘッダーエリア (右上: テーマ切り替え) --- */
        .header-right {
            position: fixed; top: 10px; right: 10px; z-index: 1001;
            display: flex; align-items: center;
        }

        .icon-btn {
            background: none; border: none; cursor: pointer;
            width: 48px; height: 48px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: var(--text-sub); transition: background-color 0.2s;
            background-color: rgba(255,255,255,0.5); /* 背景とのコントラスト確保用 */
            backdrop-filter: blur(4px);
        }
        [data-theme="dark"] .icon-btn { background-color: rgba(0,0,0,0.3); }

        .icon-btn:hover { background-color: var(--hover-bg); color: var(--text-main); }
        .icon-btn svg { width: 24px; height: 24px; fill: currentColor; }

        /* --- サイドバー --- */
        .sidebar {
            width: var(--sidebar-width); background-color: var(--bg-sidebar);
            height: 100vh; position: fixed; left: calc(var(--sidebar-width) * -1);
            top: 0; transition: left 0.3s cubic-bezier(0.2, 0, 0, 1);
            z-index: 1000; display: flex; flex-direction: column;
            padding-top: 70px; box-sizing: border-box;
            border-right: 1px solid var(--border-color);
        }
        .sidebar.active { left: 0; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 0 12px; }
        
        /* 設定ボタン削除に伴いフッター削除 */
        
        .nav-item {
            display: flex; align-items: center; padding: 12px 24px;
            margin-bottom: 4px; border-radius: 24px; cursor: pointer;
            color: var(--text-main); font-weight: 500; transition: background-color 0.2s;
        }
        .nav-item:hover { background-color: var(--hover-bg); }
        .nav-item.current { background-color: var(--hover-bg); font-weight: bold; }

        /* --- メインコンテンツ --- */
        .main-content {
            flex: 1; width: 100%; max-width: 900px; margin: 0 auto;
            padding: 80px 20px 40px; box-sizing: border-box;
            transition: margin-left 0.3s cubic-bezier(0.2, 0, 0, 1);
            word-wrap: break-word; overflow-wrap: break-word;
        }

        @media (min-width: 768px) {
            .sidebar.active ~ .main-content {
                margin-left: var(--sidebar-width);
                width: calc(100% - var(--sidebar-width));
            }
            .main-content { padding: 80px 40px 40px; }
        }

        /* --- オーバーレイ --- */
        .overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.3); z-index: 999;
        }
        @media (max-width: 767px) { .overlay.active { display: block; } }

        /* --- 共通コンポーネント --- */
        h2 { font-size: 24px; font-weight: 400; color: var(--text-main); margin-bottom: 24px; display: flex; align-items: center; flex-wrap: wrap; }
        
        .fav-header-btn { background: none; border: none; cursor: pointer; margin-left: 10px; color: var(--text-sub); font-size: 1.5rem; }
        .fav-header-btn.active { color: var(--accent-yellow); }

        .flat-list-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 0; border-bottom: 1px solid var(--border-color);
            cursor: pointer; transition: background-color 0.1s;
        }
        .flat-list-item:hover { background-color: var(--hover-bg); }
        .flat-item-name { font-size: 16px; font-weight: 500; }

        input[type="text"], input[type="number"], select {
            width: 100%; padding: 12px 16px; margin-bottom: 20px;
            border: 1px solid var(--border-color); border-radius: 4px;
            background-color: var(--bg-input); color: var(--text-main);
            box-sizing: border-box; font-size: 16px;
        }
        input:focus, select:focus { outline: 2px solid var(--text-main); border-color: transparent; }

        button.action-btn {
            padding: 10px 24px; background-color: var(--accent-red); color: #fff;
            border: none; border-radius: 20px; cursor: pointer;
            font-size: 14px; font-weight: 500; transition: opacity 0.2s;
        }
        button.action-btn:hover { opacity: 0.9; }
        [data-theme="dark"] button.action-btn { color: #331200; font-weight: bold; }

    </style>
</head>
<body>

    <div class="header-left">
        <button class="icon-btn" onclick="toggleMenu()" title="メニュー">
            <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
        </button>
        <button class="icon-btn" onclick="handleNav('home')" title="ホーム">
            <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
        </button>
    </div>

    <div class="header-right">
        <button class="icon-btn" onclick="toggleTheme()" id="theme-btn" title="テーマ切り替え">
            <svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-3.03 0-5.5-2.47-5.5-5.5 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>
        </button>
    </div>

    <div class="overlay" onclick="toggleMenu()"></div>

    <nav class="sidebar" id="sidebar">
        <div class="sidebar-content" id="menu-list"></div>
    </nav>

    <div class="main-content" id="app"></div>

    <script>
        const sidebar = document.getElementById('sidebar');
        const overlay = document.querySelector('.overlay');
        const app = document.getElementById('app');
        const themeBtn = document.getElementById('theme-btn');
        let allToolsData = [];

        // --- テーマ管理機能 ---
        function initTheme() {
            // 保存された設定がなければシステム設定を確認
            let savedTheme = localStorage.getItem('mtools_theme');
            if (!savedTheme) {
                savedTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            applyTheme(savedTheme);
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
            const next = current === 'dark' ? 'light' : 'dark';
            localStorage.setItem('mtools_theme', next);
            applyTheme(next);
        }

        function applyTheme(mode) {
            if (mode === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                // 月アイコンを表示 (現在はダークモード)
                themeBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-3.03 0-5.5-2.47-5.5-5.5 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>';
            } else {
                document.documentElement.removeAttribute('data-theme');
                // 太陽アイコンを表示 (現在はライトモード)
                themeBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79 1.42-1.41zM4 10.5H1v2h3v-2zm9-9.95h-2V3.5h2V.55zm7.45 3.91l-1.41-1.41-1.79 1.79 1.41 1.41 1.79-1.79zm-3.21 13.7l1.79 1.8 1.41-1.41-1.8-1.79-1.4 1.4zM20 10.5v2h3v-2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm-1 16.95h2V19.5h-2v2.95zm-7.45-3.91l1.41 1.41 1.79-1.8-1.41-1.41-1.79 1.8z"/></svg>';
            }
        }

        // --- 初期化 & ナビゲーション ---
        function init() {
            initTheme(); 
            if (window.innerWidth >= 768) sidebar.classList.add('active');
            
            loadMenu().then(() => {
                const hash = window.location.hash.replace('#', '');
                loadTool(hash || 'home');
            });
        }

        function toggleMenu() {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        async function loadMenu() {
            try {
                const res = await fetch('/api/tools');
                allToolsData = await res.json();
                renderSidebar();
            } catch (e) {
                console.error(e);
            }
        }

        function renderSidebar() {
            const list = document.getElementById('menu-list');
            list.innerHTML = '';
            
            allToolsData.forEach(tool => {
                const div = document.createElement('div');
                div.className = 'nav-item';
                div.textContent = tool.name;
                div.id = `nav-${tool.id}`;
                div.onclick = () => handleNav(tool.id);
                list.appendChild(div);
            });
        }

        function handleNav(id) {
            loadTool(id);
            if (window.innerWidth < 768 && sidebar.classList.contains('active')) {
                toggleMenu();
            }
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('current'));
            const active = document.getElementById(`nav-${id}`);
            if(active) active.classList.add('current');
        }

        async function loadTool(toolId) {
            window.location.hash = toolId;
            if (toolId === 'home') { renderHome(); return; }
            try {
                const tool = allToolsData.find(t => t.id === toolId);
                const path = tool ? `/tools/${tool.file}` : `/tools/${toolId}.html`;
                const res = await fetch(path);
                if (!res.ok) throw new Error('Tool not found');
                const html = await res.text();
                app.innerHTML = html;
                executeScripts(app);

                const header = app.querySelector('h2');
                if (header) {
                    const favBtn = document.createElement('button');
                    favBtn.className = 'fav-header-btn';
                    favBtn.title = 'お気に入りに追加/削除';
                    updateFavBtnState(favBtn, toolId);
                    favBtn.onclick = () => {
                        toggleFavorite(toolId);
                        updateFavBtnState(favBtn, toolId);
                    };
                    header.appendChild(favBtn);
                }
            } catch (e) {
                app.innerHTML = `<p>ページが見つかりません。</p><button class="action-btn" onclick="handleNav('home')">ホームへ戻る</button>`;
            }
        }

        function updateFavBtnState(btn, id) {
            const isFav = getFavorites().includes(id);
            btn.innerHTML = isFav ? '★' : '☆';
            if (isFav) btn.classList.add('active');
            else btn.classList.remove('active');
        }

        function renderHome() {
            const favIds = getFavorites();
            const favTools = allToolsData.filter(t => favIds.includes(t.id));
            const allTools = allToolsData;
            let html = `<h2>ホーム</h2>`;
            if (favTools.length > 0) {
                html += `<div style="margin-bottom: 30px;"><small style="color:var(--text-sub); font-weight:bold;">お気に入り</small>`;
                favTools.forEach(tool => {
                    html += `<div class="flat-list-item" onclick="handleNav('${tool.id}')">
                                <span class="flat-item-name">★ ${tool.name}</span>
                                <span style="color:var(--text-sub);">></span>
                             </div>`;
                });
                html += `</div>`;
            }
            html += `<div><small style="color:var(--text-sub); font-weight:bold;">すべてのツール</small>`;
            allTools.forEach(tool => {
                html += `<div class="flat-list-item" onclick="handleNav('${tool.id}')">
                            <span class="flat-item-name">${tool.name}</span>
                            <span style="color:var(--text-sub);">></span>
                         </div>`;
            });
            html += `</div>`;
            app.innerHTML = html;
        }

        function getFavorites() { return JSON.parse(localStorage.getItem('mtools_favs') || '[]'); }
        function toggleFavorite(id) {
            let favs = getFavorites();
            if (favs.includes(id)) favs = favs.filter(f => f !== id);
            else favs.push(id);
            localStorage.setItem('mtools_favs', JSON.stringify(favs));
        }

        function executeScripts(container) {
            container.querySelectorAll('script').forEach(oldScript => {
                const newScript = document.createElement('script');
                Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                oldScript.parentNode.replaceChild(newScript, oldScript);
            });
        }

        init();
        
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768 && !sidebar.classList.contains('active')) {
                sidebar.classList.add('active');
            }
            if (window.innerWidth < 768 && sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            }
        });
    </script>
</body>
</html>